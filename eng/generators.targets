<Project>
  <PropertyGroup>
    <EnableLibraryImportGenerator Condition="'$(EnableLibraryImportGenerator)' == '' and
                                             '$(MSBuildProjectName)' == 'System.Private.CoreLib'">true</EnableLibraryImportGenerator>
  </PropertyGroup>

  <ItemGroup>
    <EnabledGenerators Include="LibraryImportGenerator" Condition="'$(EnableLibraryImportGenerator)' == 'true'" />
    <!-- If the current project is not System.Private.CoreLib, we enable the LibraryImportGenerator source generator
         when the project is a C# source project that:
         - doesn't target the latest TFM or
         - doesn't reference the targeting pack (i.e. when inbox) and
          - references System.Private.CoreLib, or
          - references System.Runtime.InteropServices -->
    <EnabledGenerators Include="LibraryImportGenerator"
                       Condition="'$(EnableLibraryImportGenerator)' == '' and
                                  '$(IsSourceProject)' == 'true' and
                                  '$(MSBuildProjectExtension)' == '.csproj' and
                                  (
                                    '$(TargetFrameworkMoniker)' != '$(NetCoreAppCurrentTargetFrameworkMoniker)' or
                                    (
                                      '$(DisableImplicitFrameworkReferences)' == 'true' and
                                      (
                                        (
                                          '@(Reference)' != '' and
                                          @(Reference->AnyHaveMetadataValue('Identity', 'System.Runtime.InteropServices'))
                                        ) or
                                        (
                                          '@(ProjectReference)' != '' and
                                          @(ProjectReference->AnyHaveMetadataValue('Identity', '$(CoreLibProject)'))
                                        )
                                      )
                                    )
                                  )" />
  </ItemGroup>

  <ItemGroup Condition="'@(EnabledGenerators)' != '' and
                        @(EnabledGenerators->AnyHaveMetadataValue('Identity', 'LibraryImportGenerator')) and
                        !$([MSBuild]::IsTargetFrameworkCompatible('$(TargetFramework)', 'net7.0'))">
    <Compile Include="$(CoreLibSharedDir)System\Runtime\InteropServices\LibraryImportAttribute.cs" />
    <Compile Include="$(CoreLibSharedDir)System\Runtime\InteropServices\StringMarshalling.cs" />
  </ItemGroup>

  <!-- Use this complex item list based filtering to add the ProjectReference to make sure dotnet/runtime stays compatible with NuGet Static Graph Restore.
       That is required as the EnabledGenerators condition checks on the Reference and ProjectReference items and hence can't be a property condition. -->
  <ItemGroup Condition="'@(EnabledGenerators)' != '' and
                        @(EnabledGenerators->AnyHaveMetadataValue('Identity', 'LibraryImportGenerator'))">
    <AnalyzerReference Include="$(LibrariesProjectRoot)System.Runtime.InteropServices\gen\LibraryImportGenerator\LibraryImportGenerator.csproj;
                                $(LibrariesProjectRoot)System.Runtime.InteropServices\gen\Microsoft.Interop.SourceGeneration\Microsoft.Interop.SourceGeneration.csproj" />
  </ItemGroup>

  <!-- AnalyzerReference items are transformed to ProjectReferences with the required analyzer metadata. -->
  <ItemGroup>
    <ProjectReference Include="@(AnalyzerReference)"
                      ReferenceOutputAssembly="false"
                      OutputItemType="Analyzer"
                      Pack="false" />
    <ProjectReference Update="@(AnalyzerReference->WithMetadataValue('ReferenceAnalyzer', 'false'))"
                      OutputItemType="" />
  </ItemGroup>

  <!--
    Define all of the configuration options supported for the LibraryImportGenerator.
    To use, set an MSBuild property with the name of the option to `true`.
    See OptionsHelper.cs for more information on usage.
  -->
  <ItemGroup>
      <!--
        Use the System.Runtime.InteropServices.Marshal type instead of
        the System.Runtime.InteropServices.MarshalEx type when emitting code.
      -->
      <CompilerVisibleProperty Include="LibraryImportGenerator_UseMarshalType" />
      <!--
        Generate a stub that forwards to a runtime implemented P/Invoke stub instead
        of generating a stub that handles all of the marshalling.
      -->
      <CompilerVisibleProperty Include="LibraryImportGenerator_GenerateForwarders" />
  </ItemGroup>
</Project>
